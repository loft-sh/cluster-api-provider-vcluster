name: Tests

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: Run the build with upterm debugging enabled
          (https://github.com/lhotari/action-upterm/)
        required: false
        default: false
  push:
    tags:
      - v*
    branches:
      - main
    paths:
      - "**/*.go"
  pull_request:

concurrency:
  group: e2e-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  unit-test:
    runs-on: ubuntu-latest
    name: Unit Test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: false

      - name: Run Unit Tests
        run: go test ./test/controllerstest

  e2e:
    runs-on: ubuntu-latest

    name: E2E Test
    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: false

      - name: Install Prerequisites
        run: |

          # Install clusterctl
          curl -L https://github.com/kubernetes-sigs/cluster-api/releases/download/v1.11.2/clusterctl-linux-amd64 -o clusterctl
          chmod +x clusterctl
          sudo mv clusterctl /usr/local/bin/

          #Install Kind
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.30.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

          # Install envsubst
          GOBIN="$(pwd)/bin" go install -tags tools github.com/drone/envsubst/v2/cmd/envsubst@v2.0.0-20210730161058-179042472c46

          # Install kubectl
          curl -LO "https://dl.k8s.io/release/v1.33.2/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl

          # Install vcluster
          curl -Lo vcluster https://github.com/loft-sh/vcluster/releases/latest/download/vcluster-linux-amd64
          chmod +x ./vcluster
          sudo mv ./vcluster /usr/local/bin/vcluster

          # Install DevSpace
          curl -fsSL -o /tmp/devspace https://github.com/devspace-cloud/devspace/releases/latest/download/devspace-linux-amd64
          chmod +x /tmp/devspace
          sudo mv /tmp/devspace /usr/local/bin/devspace          

      - name: Create and Start Kind Cluster
        run: |
          kind create cluster --image=kindest/node:v1.33.2
          echo "=== cluster-info ==="
          kubectl cluster-info --context kind-kind

      - name: Init
        run: |
          clusterctl init
          echo "=== config get-contexts ==="
          kubectl config get-contexts

      - name: Deploy
        run: |
          devspace deploy -p deploy

      - name: Display Kubernetes Env
        run: |
          echo "=== Kubectl version ==="
          kubectl version
          echo "=== Kubectl config ==="
          kubectl config view
          echo "=== Kubectl get pods ==="
          kubectl get pods -A
          echo "=== Kubectl get namespaces ==="
          kubectl get namespaces
          echo "=== Test get crd ==="
          kubectl get crd

      - name: Create VCluster Custom Resource K8S
        run: |
          export CLUSTER_NAME=vcluster-k8s
          export CLUSTER_NAMESPACE=vcluster-k8s
          export CHART_NAME=vcluster
          export VCLUSTER_YAML=$(cat ./test/e2e/values.yaml | sed -z 's/\n/\\n/g')
          kubectl create namespace ${CLUSTER_NAMESPACE}
          cat templates/cluster-template.yaml | ./bin/envsubst | kubectl apply -n ${CLUSTER_NAMESPACE} -f -

      - name: Validate Resource Ready K8S
        run: |
          kubectl wait --for=condition=ready vcluster.infrastructure.cluster.x-k8s.io -n vcluster-k8s vcluster-k8s --timeout=100s

      - name: Connect to vcluster and install nginx
        run: |
          vcluster -n vcluster-k8s connect vcluster-k8s --background-proxy=true
          kubectl create namespace demo-nginx
          kubectl -n demo-nginx create deployment nginx-deployment --image=nginx
          kubectl -n demo-nginx rollout status deployment/nginx-deployment --timeout=100s
          vcluster disconnect
      
      - name: Print logs if e2e tests fail
        if: ${{ failure() }}
        run: |
          set -x
          free -h
          df -h
          docker system df
          lscpu
          echo "======================================================================================================================"
          kubectl get clusters -o yaml -n vcluster-k8s
          kubectl get vclusters -o yaml -n vcluster-k8s
          echo "======================================================================================================================"
          kubectl get pods -o yaml -n vcluster-k8s
          echo "======================================================================================================================"
          kubectl get events -n vcluster-k8s --sort-by='.lastTimestamp'
          echo "======================================================================================================================"
          kubectl get pods -A
          echo "======================================================================================================================"
          kubectl get ns
          echo "======================================================================================================================"
          kubectl logs -l release=vcluster-k8s -n vcluster-k8s --tail=-1 -p || kubectl logs -l release=vcluster-k8s -n vcluster-k8s --tail=-1
          exit 1
